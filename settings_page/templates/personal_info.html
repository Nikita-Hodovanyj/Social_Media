{% extends 'base.html' %}
{% load static %}

{% block title %}
    –û—Å–æ–±–∏—Å—Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
{% endblock %}

{% block link %}
<link rel="stylesheet" href="{% static 'css/personal_info.css' %}">
{% endblock %}

{% block content %}
<div class="main-wrapper">

    <aside>
         <div class='div-link-info1'>
             <a class='link-info1' href="{% url 'personal_info' %}">–û—Å–æ–±–∏—Å—Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</a>
         </div>
         <div class='div-link-albums1'>
            <a class='link-albums1' href="{% url 'albums' %}">–ê–ª—å–±–æ–º–∏</a>
         </div>
    </aside>

    <main>
        <div class="profile-card" id="profileView">
            <div class='edit-profile'>
                <p class="text-info">–ö–∞—Ä—Ç–∫–∞ –ø—Ä–æ—Ñ—ñ–ª—é</p>
                <button class="edit-button">
                    <img src="{% static 'images/pen.svg' %}" alt="">
                    –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
                </button>
            </div>

            <div class='avatar-info'>
                {% if avatar %}
                    <img id="profileAvatar" src="{{ avatar.url }}" alt="avatar" >
                {% else %}
                    <img id="profileAvatar" src="{% static 'images/avatar.png' %}" alt="avatar" >
                {% endif %}

                <div>
                    <p class="name-text" id="nameText">{{ user.first_name }}</p>
                    <p class="username-text" id="usernameText">{{ user.username }}</p>
                </div>
            </div>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="personal-info" id="profileEdit" style="display: none;">
            <div class="edit-profile">
                <p class="text-info">–ö–∞—Ä—Ç–∫–∞ –ø—Ä–æ—Ñ—ñ–ª—é</p>
                <button class="save-button">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>

            <p class="center-text">–û–±–µ—Ä—ñ—Ç—å –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é</p>

            <div class="avatar-upload">
                <img id="avatarPreview" src="{% if avatar %}{{ avatar.url }}{% else %}{% static 'images/avatar.png' %}{% endif %}" alt="avatar" class="avatar-preview" style="width:150px; height:150px; object-fit:cover; border-radius:50%;">
                <div class="photo-buttons">
                    <label class="custom-upload">
                        <input type="file" id="uploadPhoto" name="avatar" style="display: none;">
                        <span>‚ûï –î–æ–¥–∞–π—Ç–µ —Ñ–æ—Ç–æ</span>
                    </label>
                    
                </div>
            </div>

            <p class="profile-name" id="profileName">{{ user.first_name }} {{ user.last_name }}</p>

            <div class="input-class">
                <label for="username">–Ü–º‚Äô—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</label>
                <input id="inputUsername" type="text" name="username" data-field="username" value="{{ user.username }}">
            </div>
        </div>

        <div class="info-card" id="infoCard">
            <div class='edit-profile'>
                <p class="text-info">–û—Å–æ–±–∏—Å—Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</p>

                <button  class="edit-button1">
                    <img src="{% static 'images/pen.svg' %}" alt="">
                    –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
                </button>
                <button class="save-button-info" style="display:none;">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>

            <div class="inputs-info">
                <div class="input-class">
                    <label for="first_name">–Ü–º‚Äô—è</label>
                    <div class="eye-input-div">
                        <input id="inputFirstName" name="first_name" data-field="first_name" type="text" value="{{ user.first_name }}">
                        <img src="{% static 'images/open-eye.png' %}" alt="">
                    </div>
                </div>

                <div class="input-class">
                     <label for="last_name">–ü—Ä—ñ–∑–≤–∏—â–µ</label>
                    <div class="eye-input-div">
                        <input id="inputLastName" name="last_name" data-field="last_name" type="text" value="{{ user.last_name }}">
                        <img src="{% static 'images/open-eye.png' %}" alt="">
                    </div>
                </div>

                <div class="input-class">
                    <label for="date">–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</label>
                    <div class="eye-input-div">
                        <input id="inputDate" type="date" value="">
                        <img src="{% static 'images/open-eye.png' %}" alt="">
                    </div>
                </div>

                <div class="input-class">
                    <label for="email">–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –∞–¥—Ä–µ—Å–∞</label>
                    <div class="eye-input-div">
                        <input id="inputEmail" name="email" data-field="email" type="email" value="{{ user.email }}">
                        <img src="{% static 'images/open-eye.png' %}" alt="">
                    </div>
                </div>

                <div class="input-password">
                    <label for="password">–ü–∞—Ä–æ–ª—å</label>
                    <div class="eye-input-password">
                        <input id="password" type="password" placeholder="‚Åï‚Åï‚Åï‚Åï‚Åï‚Åï‚Åï‚Åï‚Åï‚Åï">
                        <img src="{% static 'images/close-eye.svg' %}" alt="">
                    </div>
                </div>
            </div>
        </div>

        <div class='writing-card'>
            <div class='edit-profile'>
                <p class="text-info">–í–∞—Ä—ñ–∞–Ω—Ç–∏ –ø—ñ–¥–ø–∏—Å—É</p>
                
                <button class="edit-button1">
                    <img src="{% static 'images/pen.svg' %}" alt="">
                    –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
                </button>
            </div>

            <div class="name-writing">
                <div class="check-div">
                    <label for="nameSurname" class="label-name-surname">
                        <img src="{% static 'images/outline-checkbox.svg' %}" alt="">
                        <p>–Ü–º‚Äô—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ</p>
                    </label>
                    <p>Lina Li</p>
                </div>

                <div class="check-div">
                    <label for="myWriting" class="label-name-surname">
                        <img src="{% static 'images/outline-checkbox.svg' %}" alt="">
                        <p>–ú—ñ–π –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π –ø—ñ–¥–ø–∏—Å</p>
                    </label>
                    <img class='writing-image' src="{% static 'images/writing.png' %}" alt="">
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const inputs = document.querySelectorAll('input[name="first_name"], input[name="last_name"], input[name="email"], input[name="username"]');
        const profileView = document.getElementById('profileView');
        const profileEdit = document.getElementById('profileEdit');
        const editButtons = document.querySelectorAll('.edit-button');  // –∏ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è, –∏ –¥–ª—è infoCard
        const saveButtonProfile = document.querySelector('.save-button');  // –æ–¥–Ω–∞ –æ–±—â–∞—è "–ó–±–µ—Ä–µ–≥—Ç–∏"
        const saveButtonInfo = document.querySelector('.save-button-info');  // –¥—Ä—É–≥–∞—è "–ó–±–µ—Ä–µ–≥—Ç–∏"
        const uploadInput = document.getElementById('uploadPhoto');
        const avatarPreview = document.getElementById('avatarPreview');
    
        let selectedAvatarFile = null;
    
        const editButtonInfoCard = document.querySelector('.edit-button1');
        const infoCard = document.getElementById('infoCard');
    
        // –°–Ω–∞—á–∞–ª–∞ –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—è
        inputs.forEach(input => input.setAttribute('readonly', true));
    
        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è infoCard
        editButtonInfoCard?.addEventListener('click', () => {
            infoCard.classList.remove('disabled');
            inputs.forEach(input => input.removeAttribute('readonly'));
            editButtonInfoCard.style.display = 'none';
            saveButtonInfo.style.display = 'inline-block';
        });
    
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞
        uploadInput?.addEventListener('change', () => {
            const file = uploadInput.files[0];
            if (file) {
                selectedAvatarFile = file;
                const reader = new FileReader();
                reader.onload = e => avatarPreview.src = e.target.result;
                reader.readAsDataURL(file);
            }
        });
    
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É profileView –∏ profileEdit
        editButtons.forEach(button => {
            button.addEventListener('click', () => {
                profileView.style.display = 'none';
                profileEdit.style.display = 'block';
                inputs.forEach(input => input.removeAttribute('readonly'));
                saveButtonProfile.style.display = 'inline-block';
            });
        });
    
        // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function saveChanges() {
            const formData = new FormData();
            inputs.forEach(input => {
                formData.append(input.name, input.value);
            });
    
            if (selectedAvatarFile) {
                formData.append('avatar', selectedAvatarFile);
            }
    
            fetch("{% url 'update_user_info' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie('csrftoken'),
                },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
                    document.getElementById('profileName').textContent = `${data.first_name} ${data.last_name}`;
                    document.getElementById('nameText').textContent = data.first_name;
                    document.getElementById('usernameText').textContent = data.username;
    
                    if (data.avatar_url) {
                        avatarPreview.src = data.avatar_url;
                        document.getElementById('profileAvatar').src = data.avatar_url;
                    }
    
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ readonly
                    inputs.forEach(input => input.setAttribute('readonly', true));
                    infoCard.classList.add('disabled');
    
                    // –ü—Ä—è—á–µ–º "–ó–±–µ—Ä–µ–≥—Ç–∏", –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏"
                    saveButtonProfile.style.display = 'none';
                    saveButtonInfo.style.display = 'none';
                    editButtonInfoCard.style.display = 'inline-block';
    
                    // –°–±—Ä–æ—Å input file
                    selectedAvatarFile = null;
                    uploadInput.value = "";
    
                    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ
                    profileEdit.style.display = 'none';
                    profileView.style.display = 'block';
    
                } 
            })
        
        }
    
        // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫ "–ó–±–µ—Ä–µ–≥—Ç–∏"
        saveButtonProfile?.addEventListener('click', saveChanges);
        saveButtonInfo?.addEventListener('click', saveChanges);
    });
    </script>
    

{% endblock %}
